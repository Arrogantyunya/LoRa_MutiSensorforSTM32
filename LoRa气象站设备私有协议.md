# LoRa气象站设备私有协议

# 公共协议

## LoRa传感器上报设备参数（申请号码（E011））

#### 协议帧格式

|   字节索引   |     0     |  1\|2   |    3    |     4\|5     |      6      |   7    |     8-12     |       13-21        |   22    |  23-24   |     25-31      |      32-39       |  40  |       41-46       |
| :----------: | :-------: | :-----: | :-----: | :----------: | :---------: | :----: | :----------: | :----------------: | :-----: | :------: | :------------: | :--------------: | :--: | :---------------: |
|    数据域    | FrameHead | FrameId | DataLen | DeviceTypeId | IsBroadcast | ZoneId | GroupIdArray |      DeviceSn      | channel | Interval |    NewTime     |     Allocate     | CRC8 |     FrameEnd      |
| 长度（byte） |     1     |    2    |    1    |      2       |      1      |   1    |      5       |         9          |    1    |    2     |       7        |        8         |  1   |         2         |
|   示例数据   |    FE     |  E011   |   24    |     0001     |     00      |   55   |   01000000   | 000000000000000000 |   00    |  00 3C   | 20180824141702 | 0000000000000000 |  00  | 0D 0A 0D 0A 0D 0A |

协议帧各字段域说明：

| 字段域       | 说明                   | 长度（byte） | 备注                                                         |
| ------------ | :--------------------- | :----------: | :----------------------------------------------------------- |
| FrameHead    | 帧头                   |      2       | FE                                                           |
| FrameId      | 帧ID                   |      2       | E011                                                         |
| DataLen      | 数据长度               |      1       | 从此位后开始计算（不包含自身），一直到`CRCR8`位结束（不包括CRC8位） |
| DeviceTypeId | 设备类型ID             |      2       | 查看设备类型对照表                                           |
| IsBroadcast  | 是否广播指令           |      1       | 0x55是，00否                                                 |
| ZoneId       | 所属区域Id             |      1       | 0x55表示所有区域                                             |
| channel      | 子设备路数             |      1       | 0x00表示主设备（无子设备情况），其他表示相应路数             |
| GroupIdArray | 组编号数组             |      5       | 最多5个组，组id(2byte)不为00时有效                           |
| Interval     | LoRa设备的采集时间间隔 |      2       | 十六进制整数，单位为秒                                       |
| NewTime      | 新设置的RTC时间        |      7       | BCD码值，如`20180824141702`代表`2018年8月24日14点17分零2秒`  |
| Allocate     | 预留字段               |      8       | 预留做他用                                                   |
| CRC8         | CRC8校验码             |      1       | 用于进行CRC8计算的数据DataLen指代的长度                      |
| FrameEnd     | 帧尾                   |      6       | 0d 0a 0d 0a 0d 0a                                            |

**应用示例：**

ID为`14052A0C`的LoRa设备上报当前设备参数：

```javascript

```

### 基地服务器设置设备SN及子设备总路数(A013)

#### 协议帧格式

|   字节索引   |       N/A       |   N/A    |     N/A      |     0     |  1\|2   |    3    |     4\|5     |      6      |   7    |       8       |      9      |      10-18       |  19  |       20-25       |
| :----------: | :-------------: | :------: | :----------: | :-------: | :-----: | :-----: | :----------: | :---------: | :----: | :-----------: | :---------: | :--------------: | :--: | :---------------: |
|    数据域    | DeviceFrameHead |   Addr   | DeviceOthers | FrameHead | FrameId | DataLen | DeviceTypeId | IsBroadcast | ZoneId | DeviceChannel | SlaverCount |     DeviceSn     | CRC8 |     FrameEnd      |
| 长度（byte） |        1        |    4     |      3       |     1     |    2    |    1    |      2       |      1      |   1    |       1       |      1      |        9         |  1   |         2         |
|   示例数据   |       61        | 14052A0C |   00 XXXX    |    FE     |  E013   |   0F    |     0001     |     00      |   01   |      00       |     00      | 0001XXXXXXXXXXXX |  00  | 0D 0A 0D 0A 0D 0A |

协议帧各字段域说明：

| 字段域          | 说明             | 长度（byte） | 备注                                                         |
| --------------- | :--------------- | :----------: | :----------------------------------------------------------- |
| DeviceFrameHead | 硬件帧头         |      1       | 仁钰LoRa M-KL9按地址发送时需要                               |
| Addr            | 设备地址         |      4       | 00000071(广播，所有设备上报自己的ID和SN)                     |
| DeviceOthers    | 控制字等         |      3       | 仁钰LoRa M-KL9按地址发送时需要                               |
| FrameHead       | 帧头             |      1       | FE                                                           |
| FrameId         | 帧ID             |      2       | A013                                                         |
| DataLen         | 数据长度         |      1       | 从此位后开始计算（不包含自身），一直到`CRCR8`位结束（不包括CRC8位） |
| DeviceTypeId    | 设备类型ID       |      2       | 查看设备类型对照表                                           |
| IsBroadcast     | 是否广播指令     |      1       | 0x55是，00否                                                 |
| ZoneId          | 所属区域Id       |      1       | 0x55表示所有区域                                             |
| DeviceChannel   | 设备路数         |      1       | 主设备：0x00                                                 |
| SlaverCount     | 子设备总路数     |      1       | 子设备总数                                                   |
| DeviceSn        | 设置的LoRa设备SN |      9       |                                                              |
| CRC8            | CRC8校验码       |      1       | 用于进行CRC8计算的数据DataLen指代的长度                      |
| FrameEnd        | 帧尾             |      6       | 0d 0a 0d 0a 0d 0a                                            |

**应用示例：**

```javascript

```



## 设置LoRa传感器的RTC时间和采集时间间隔(A011)

**ZoneId=0x55,intent=0x00,channel=0x00设置参数**,地址为广播地址，设置某类型所有设备

#### 协议帧格式

|   字节索引   |       N/A       |   N/A    |     N/A      |     0     |  1\|2   |    3    |     4\|5     |   6    |   7    |    8    |   9-10   |     11-17      |      18-25       |  26  |       27-31       |
| :----------: | :-------------: | :------: | :----------: | :-------: | :-----: | :-----: | :----------: | :----: | :----: | :-----: | :------: | :------------: | :--------------: | :--: | :---------------: |
|    数据域    | DeviceFrameHead |   Addr   | deviceOthers | FrameHead | FrameId | DataLen | DeviceTypeId | ZoneId | intent | channel | Interval |    NewTime     |     Allocate     | CRC8 |     FrameEnd      |
| 长度（byte） |        1        |    4     |      3       |     1     |    2    |    1    |      2       |   1    |   1    |    1    |    2     |       7        |        8         |  1   |         2         |
|   示例数据   |       61        | 00000071 |   00 XXXX    |    FE     |  A011   |   1A    |     C001     |   01   |   00   |   00    |  00 3C   | 20180824141702 | 0000000000000000 |  00  | 0D 0A 0D 0A 0D 0A |

协议帧各字段域说明：

| 字段域          | 说明                     | 长度（byte） | 备注                                                         |
| --------------- | :----------------------- | :----------: | :----------------------------------------------------------- |
| DeviceFrameHead | 硬件帧头                 |      1       | LoRa 按地址发送时需要                                        |
| Addr            | 设备地址                 |      4       | 00000071(广播，所有设备上报自己的ID和SN)                     |
| deviceOthers    | 控制字等                 |      3       | LoRa 按地址发送时需要                                        |
| FrameHead       | 帧头                     |      2       | FE                                                           |
| FrameId         | 帧ID                     |      2       | A011                                                         |
| DataLen         | 数据长度                 |      1       | 从此位后开始计算（不包含自身），一直到`CRCR8`位结束（不包括CRC8位） |
| DeviceTypeId    | 设备类型ID               |      2       | 查看设备类型对照表（5555：所有类型）                         |
| ZoneId          | 所属区域Id               |      1       | 0x55表示所有区域                                             |
| intent          | 要求LoRa设备重新请求分号 |      1       | 0x00：不请求只设置参数，0x55：重新请求                       |
| channel         | 查询角色                 |      1       | 0x00：表示主控，0x55:表示所有设备参数，其他表示相应路数的子设备 |
| Interval        | LoRa设备的采集时间间隔   |      2       | 十六进制整数，单位为秒                                       |
| NewTime         | 新设置的RTC时间          |      7       | BCD码值，如`20180824141702`代表`2018年8月24日14点17分零2秒`  |
| Allocate        | 预留字段                 |      8       | 预留做他用                                                   |
| CRC8            | CRC8校验码               |      1       | 用于进行CRC8计算的数据DataLen指代的长度                      |
| FrameEnd        | 帧尾                     |      6       | 0d 0a 0d 0a 0d 0a                                            |

**应用示例：**

设置类型为11因素传感器的所有传感器采集间隔为`60`秒，新设置的RTC时间为`2018年8月24日15时20分12秒`，其指令如下：

```shell
61 00000071 000100 FE A011 1A 0001 01 00 00 003C 20190307114315 0000000000000000 ED 0D0A0D0A0D0A
```



# LoRa 11因素传感器私有协议

### LoRa无线11因素传感器数据协议 (SensorType:0001)

#### 协议帧格式如下：

**LoRa无线11因素百叶箱上传数据至网关协议帧格式**

|   字节索引   |       N/A       |   N/A    |     N/A      |     0     |  1\|2   |    3    |    4~5     |  6~7   |    8~10     |  11~13   |     14~18     |    19~23    |    24~26    | 27~29  | 30~32  |       33~35       |     35~38      |  39~41   |   42~44    |     45~51      |  52  |      53~58      |
| :----------: | :-------------: | :------: | :----------: | :-------: | :-----: | :-----: | :--------: | :----: | :---------: | :------: | :-----------: | :---------: | :---------: | :----: | :----: | :---------------: | :------------: | :------: | :--------: | :------------: | :--: | :-------------: |
|    数据域    | DeviceFrameHead |   Addr   | deviceOthers | FrameHead | FrameId | DataLen | SensorType | BatVol | Temperature | Humidity | LumiIntensity | AirPressure | UvIntensity |  CO2   | TVOCs  | Solid Temperature | Solid Humidity | Solid EC | Solid Salt |      Time      | CRC8 |    FrameEnd     |
| 长度（byte） |        1        |    4     |      3       |     1     |    2    |    1    |     2      |   2    |      3      |    3     |       5       |      5      |      3      |   3    |   3    |         3         |       3        |    3     |     3      |       7        |  1   |        6        |
|   示例数据   |       41        | 00000001 |   00 XXXX    |    FE     |  D001   |   30    |    0001    |  1051  |   2770E2    |  4679E2  |  00004142E0   |  008032E1   |   0011E2    | 0485E0 | 0012E0 |      2770E2       |     4679E2     |  0010E0  |   0010E0   | 20180824121755 |  00  | 0D 0A0D 0A0D 0A |

协议帧各字段域说明：

| 字段域          | 说明         | 长度（byte） | 备注                                                         |
| --------------- | :----------- | :----------: | :----------------------------------------------------------- |
| DeviceFrameHead | 硬件接收帧头 |      1       | 传感器LoRa帧头                                               |
| Addr            | 设备地址     |      4       | 传感器LoRa地址                                               |
| deviceOthers    | 控制字等     |      3       | 传感器LoRa控制字等                                           |
| FrameHead       | 帧头         |      1       | 数据帧头                                                     |
| FrameId         | 帧ID         |      2       | 数据帧ID                                                     |
| DataLen         | 数据长度     |      1       | 从此位后开始计算（不包含自身），一直到`CRCR8`位结束（不包括CRC8位） |
| SensorType      | 传感器类型码 |      2       | 此类型传感器的设备类型码为`00 01`                            |
| BatVol          | 传感器电压   |      2       | 单位为`mV`，十六进制表示整数                                 |
| Temperature     | 温度数据     |      3       | 单位为`摄氏度`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| Humidity        | 相对湿度     |      3       | 单位为`%`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| LumiIntensity   | 光照强度     |      5       | 单位为`Lux`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| AirPressure     | 大气压力/PH  |      5       | 单位为`kPa/`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| UvIntensity     | 紫外线强度   |      3       | 单位为`w/m2`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| CO2             | 二氧化碳浓度 |      3       | 单位为`ppm`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| TVOCs           | TVOCs浓度    |      3       | 单位为`ppm`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| Solid Temp      | 土壤温度     |      3       | 单位为`摄氏度`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| Solid Humi      | 土壤湿度     |      3       | 单位为`%`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| Solid EC        | 土壤导电率   |      3       | 单位为`us/cm`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| Solid Salt      | 土壤盐分     |      3       | 单位为`mg/L`，BCD码值，低位为符号位，符号位为`Ex`时为正，`Fx`时为负，其中`x`为小数位数 |
| Time            | 数据时间     |      7       | 时间的BCD码值                                                |
| CRC8            | CRC8校验码   |      1       | 用于进行CRC8计算的数据DataLen指代的长度                      |
| FrameEnd        | 帧尾         |      2       |                                                              |

**应用示例：**

传感器传了一笔电量值为`4177`mV，温度值为`27.70`，相对湿度为`46.79`，光照强度为`4142`, 大气压力`803.2`，紫外线强度为`1.1`， CO2浓度为`485`，TVOCs浓度为`12`,........，时间为`2018年08月24日12时17分55秒`的数据，其数据帧如下：

```shell
FE D001 30 0001 1051 2770E2 4679E2 00004142E0 008032E1 0011E2 0485E0 0012E0 2770E2 4679E2 0010E0 0010E0 20180824121755 00 0D0A0D0A0D0A
```
